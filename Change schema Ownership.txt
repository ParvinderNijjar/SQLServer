CHECK USING SP_HELPDB TEST01

--ALTER DATABASE LOGICAL NAMES



ALTER DATABASE TEST01
   MODIFY FILE (NAME = TEST02_Primary,NEWNAME = TEST01_Primary)

ALTER DATABASE TEST01
   MODIFY FILE (NAME = TEST02_Log_01,NEWNAME = TEST01_log)

ALTER DATABASE TEST01
   MODIFY FILE (NAME = TEST02_data_A_01,NEWNAME = TEST01_data_A_01)

ALTER DATABASE TEST01
   MODIFY FILE (NAME = TEST02_data_A_02,NEWNAME = TEST01_data_A_02)

ALTER DATABASE TEST01
   MODIFY FILE (NAME = TEST02_data_B_01,NEWNAME = TEST01_data_B_01)

ALTER DATABASE TEST01
   MODIFY FILE (NAME = TEST02_data_B_02,NEWNAME = TEST01_data_B_02)

ALTER DATABASE TEST01
   MODIFY FILE (NAME = TEST02_indexes_01,NEWNAME = TEST01_indexes_01)

ALTER DATABASE TEST01
   MODIFY FILE (NAME = TEST02_indexes_02,NEWNAME = TEST01_indexes_02)

ALTER DATABASE TEST01
   MODIFY FILE (NAME = TEST02_dictionary,NEWNAME = TEST01_dictionary)





USE [master]
GO
CREATE LOGIN [TEST01] WITH PASSWORD=N'????????????', 
DEFAULT_DATABASE=[TEST01], 
DEFAULT_LANGUAGE=[British], 
CHECK_EXPIRATION=OFF, CHECK_POLICY=OFF
GO






--RE-HOOK LOGIN TO DATABASE AND GRANT ACCESS LEVELS




USE [TEST01]
GO
/****** Object:  User [TEST01]    Script Date: 12/14/2010 16:49:14 ******/
GO
EXEC dbo.sp_grantdbaccess @loginame = N'TEST01', @name_in_db = N'TEST01'


USE [TEST01]
GO
EXEC sp_addrolemember N'db_owner', N'TEST01'
GO





--CREATE NEW SCHEMA IF REQUIRED


USE [TEST01]
GO
CREATE SCHEMA [TEST01] AUTHORIZATION [TEST01]
GO



--CHANGE TABLE OWNERSIP


USE[TEST01]
declare @from_schema varchar(30)
set @from_schema = 'TEST02'
declare @to_schema varchar(30)
set @to_schema = 'TEST01'
select 'ALTER SCHEMA  '+@to_schema+' TRANSFER '+@from_schema+'.'+o.name from sys.objects o 
where o.schema_id=schema_id(@from_schema) and o.type in ('u','p','fn','v') order by o.name



--RESULTS AS FOLLOWS THAT WE NEED TO THEN RUN TO CHANGE OWNERSHIP

ALTER SCHEMA  TEST01 TRANSFER TEST02.TBL01
ALTER SCHEMA  TEST01 TRANSFER TEST02.TBL02




-- DROP OLD SCHEMA

USE [TEST01]
GO

DROP SCHEMA [TEST02]
GO



-- LINK NEW SCHEMA TO NEW LOGIN IF REQUIRED


USE [TEST01]
GO
ALTER USER [TEST01] WITH DEFAULT_SCHEMA=[TEST01]
GO


-- REMOVE OLD USER


USE [TEST01]
GO
/****** Object:  User [XPOS_TEST]    Script Date: 08/18/2011 08:54:07 ******/
IF  EXISTS (SELECT * FROM sys.database_principals WHERE name = N'TEST02')
DROP USER [TEST02]



-- AUTO FIX LOGIN 

USE [TEST01]
GO
SP_CHANGE_USERS_LOGIN AUTO_FIX, TEST01
GO





DELETE ANY OTHER DB USERS THAT AREN'T REQUIRED





